<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Редирект с .php на версию без расширения (301 - постоянный редирект)
    # Только для файлов в корне сайта, исключая подпапки (admin, client, includes, backend и т.д.)
    RewriteCond %{THE_REQUEST} \s/+([^/?\s]+)\.php[\s?] [NC]
    RewriteCond %{REQUEST_URI} !^/(admin|client|includes|backend|assets|telegram_bot|data|adm|lang|ru|en)/ [NC]
    RewriteRule ^ /%1? [R=301,L]
    
    # Правила для админ-панели через /adm
    # Все запросы к /adm перенаправляются в /admin/
    RewriteCond %{REQUEST_URI} ^/adm [NC]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^adm/?(.*)$ /admin/$1 [L]
    
    # Мультиязычность: обработка языковых префиксов
    # Исключаем системные директории и файлы
    RewriteCond %{REQUEST_URI} !^/(admin|client|includes|backend|assets|telegram_bot|data|adm|lang|favicon\.ico|robots\.txt|sitemap\.xml) [NC]
    
    # Обработка языковых префиксов ru/ и en/ для всех страниц
    # Формат: /ru/services, /en/services и т.д.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(ru|en)/(services|seo|ads|about|contact|portfolio|vacancies|calculator|blog|faq|blog-post)$ /$2.php?lang=$1 [L,QSA]
    
    # Обработка корня с языковым префиксом: /ru/ или /en/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(ru|en)/?$ /index.php?lang=$1 [L,QSA]
    
    # Если запрос к корню без языкового префикса - перенаправляем на index.php
    RewriteCond %{REQUEST_URI} ^/$ [NC]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^$ /index.php [L]
    
    # Проверяем, что файл или директория не существуют
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # Правила для основных страниц сайта (без языкового префикса) - редирект на /ru/
    RewriteRule ^services$ /ru/services [R=301,L]
    RewriteRule ^seo$ /ru/seo [R=301,L]
    RewriteRule ^ads$ /ru/ads [R=301,L]
    RewriteRule ^about$ /ru/about [R=301,L]
    RewriteRule ^contact$ /ru/contact [R=301,L]
    RewriteRule ^portfolio$ /ru/portfolio [R=301,L]
    RewriteRule ^vacancies$ /ru/vacancies [R=301,L]
    RewriteRule ^calculator$ /ru/calculator [R=301,L]
    RewriteRule ^blog$ /ru/blog [R=301,L]
    RewriteRule ^faq$ /ru/faq [R=301,L]
    
    # Правила для клиентской части
    RewriteRule ^client/login$ /client/login.php [L]
    RewriteRule ^client/dashboard$ /client/dashboard.php [L]
    RewriteRule ^client/logout$ /client/logout.php [L]
    
    # Правила для админ-панели (старые пути)
    RewriteRule ^admin/projects$ /admin/projects.php [L]
</IfModule>

<FilesMatch "\.(json)$">
    <IfModule mod_headers.c>
        Header set Access-Control-Allow-Origin "*"
        Header set Content-Type "application/json"
    </IfModule>
</FilesMatch>

# Разрешаем CORS для backend файлов
<FilesMatch "^backend/.*\.php$">
    <IfModule mod_headers.c>
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "POST, GET, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, X-Requested-With"
    </IfModule>
</FilesMatch>
