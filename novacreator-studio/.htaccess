# ===================================
# HTACCESS ДЛЯ NOVACREATOR STUDIO
# SEO-оптимизированная конфигурация
# Last updated: 2025-12-02
# ===================================

# Включаем mod_rewrite
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # ===================================
    # HTTPS РЕДИРЕКТ (SSL)
    # ===================================
    # Принудительный редирект на HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # ===================================
    # WWW РЕДИРЕКТ
    # ===================================
    # Убираем www из URL (для единообразия)
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
    
    # ===================================
    # УБИРАЕМ TRAILING SLASH
    # ===================================
    # Убираем слеш в конце URL (кроме главной)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [R=301,L]
    
    # ===================================
    # ЧПУ - УБИРАЕМ .php РАСШИРЕНИЕ
    # ===================================
    # Редирект с .php на версию без расширения
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteCond %{REQUEST_URI} ^(.+)\.php$
    RewriteRule ^(.+)\.php$ /$1 [R=301,L]
    
    # Перезапись URL без .php на .php файлы
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}.php -f
    RewriteRule ^([^\.]+)$ $1.php [L]
    
    # ===================================
    # МУЛЬТИЯЗЫЧНОСТЬ
    # ===================================
    # Обработка /ru/ и /en/ префиксов
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(ru|en)/(.*)$ /$2?lang=$1 [QSA,L]
    
    # ===================================
    # ЗАЩИТА СЛУЖЕБНЫХ ФАЙЛОВ
    # ===================================
    # Запрещаем доступ к .git
    RewriteRule ^\.git - [F,L]
    
    # Запрещаем доступ к файлам конфигурации
    <FilesMatch "\.(env|json|config\.php|gitignore|htaccess|htpasswd)$">
        Require all denied
    </FilesMatch>
    
    # Защита папок
    RewriteRule ^(backend|node_modules|includes|data|lang)/.*$ - [F,L]
</IfModule>

# ===================================
# КЕШИРОВАНИЕ БРАУЗЕРА
# ===================================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Изображения
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Видео
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType video/mpeg "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    
    # Шрифты
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    
    # CSS и JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # HTML, PHP (короткий кеш для динамического контента)
    ExpiresByType text/html "access plus 1 hour"
    ExpiresByType application/xhtml+xml "access plus 1 hour"
    
    # XML и JSON
    ExpiresByType text/xml "access plus 1 hour"
    ExpiresByType application/xml "access plus 1 hour"
    ExpiresByType application/json "access plus 1 hour"
    
    # Остальное
    ExpiresDefault "access plus 1 month"
</IfModule>

# ===================================
# ЗАГОЛОВКИ CACHE-CONTROL
# ===================================
<IfModule mod_headers.c>
    # Кеширование статических ресурсов
    <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|swf|woff|woff2|ttf|otf)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
    
    # Не кешировать HTML и PHP
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
    
    # ===================================
    # БЕЗОПАСНОСТЬ - HTTP ЗАГОЛОВКИ
    # ===================================
    # Защита от XSS
    Header set X-XSS-Protection "1; mode=block"
    
    # Защита отClickJacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Защита от MIME-sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Content Security Policy (CSP) - базовый
    # Header set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com;"
    
    # Strict-Transport-Security (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Убираем информацию о сервере
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ===================================
# СЖАТИЕ GZIP
# ===================================
<IfModule mod_deflate.c>
    # Сжимаем текстовые файлы
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Исключаем старые браузеры
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    
    # Убираем Vary: User-Agent для прокси
    Header append Vary User-Agent env=!dont-vary
</IfModule>

# ===================================
# MIME ТИПЫ
# ===================================
<IfModule mod_mime.c>
    # JavaScript
    AddType application/javascript js
    AddType application/json json
    
    # Шрифты
    AddType font/ttf ttf
    AddType font/otf otf
    AddType font/woff woff
    AddType font/woff2 woff2
    
    # Изображения
    AddType image/webp webp
    AddType image/svg+xml svg svgz
    AddEncoding gzip svgz
    
    # Видео
    AddType video/mp4 mp4 m4v
    AddType video/webm webm
    
    # UTF-8 кодировка по умолчанию
    AddDefaultCharset utf-8
    AddCharset utf-8 .html .css .js .xml .json .rss .atom
</IfModule>

# ===================================
# ЗАЩИТА ОТ СПАМА И БОТОВ
# ===================================
<IfModule mod_rewrite.c>
    # Блокируем пустой User-Agent
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(-|bot) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Блокируем spam referrers
    RewriteCond %{HTTP_REFERER} (semalt\.com|buttons-for-website\.com|make-money-online\.7makemoneyonline\.com) [NC,OR]
    RewriteCond %{HTTP_REFERER} (rankings-analytics\.com|free-share-buttons\.com|darodar\.com|best-seo-solution\.com) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ===================================
# ОПТИМИЗАЦИЯ PHP
# ===================================
<IfModule mod_php7.c>
    # Увеличиваем лимиты
    php_value upload_max_filesize 32M
    php_value post_max_size 32M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
    
    # Включаем сжатие вывода PHP
    php_flag zlib.output_compression On
    php_value zlib.output_compression_level 6
    
    # Отключаем отображение ошибок (безопасность)
    php_flag display_errors Off
    php_flag display_startup_errors Off
    
    # Включаем логирование ошибок
    php_flag log_errors On
</IfModule>

# ===================================
# ЗАЩИТА WORDPRESS (если используется)
# ===================================
# Защита wp-config.php
<Files wp-config.php>
    Require all denied
</Files>

# Защита .htaccess и .htpasswd
<Files ~ "^\.ht">
    Require all denied
</Files>

# ===================================
# ИНДЕКСАЦИЯ - ДИРЕКТИВЫ ДЛЯ РОБОТОВ
# ===================================
# Для главной страницы и важных разделов
<FilesMatch "(index|services|seo|ads|portfolio|about|contact)\.php$">
    Header set X-Robots-Tag "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
</FilesMatch>

# Для админки
<FilesMatch "admin">
    Header set X-Robots-Tag "noindex, nofollow"
</FilesMatch>

# ===================================
# ОПТИМИЗАЦИЯ ETags
# ===================================
# Убираем ETags (используем кеширование через Expires)
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# ===================================
# ЗАЩИТА ОТ HOTLINKING ИЗОБРАЖЕНИЙ
# ===================================
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?novacreatorstudio\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?novacreator-studio\.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,NC,L]
</IfModule>

# ===================================
# CUSTOM ERROR PAGES
# ===================================
ErrorDocument 404 /404.php
ErrorDocument 500 /500.php

# ===================================
# ПРЕДОТВРАЩЕНИЕ DIRECTORY LISTING
# ===================================
Options -Indexes

# ===================================
# ОПТИМИЗАЦИЯ СЖАТИЯ BROTLI (если доступен)
# ===================================
<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/x-javascript application/json
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# ===================================
# LIMIT REQUEST SIZE (защита от DDoS)
# ===================================
<IfModule mod_reqtimeout.c>
    RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>

# Ограничение размера запроса
LimitRequestBody 10485760

# ===================================
# КОНЕЦ ФАЙЛА .htaccess
# ===================================
